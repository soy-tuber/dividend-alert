name: Portfolio Monitor

on:
  schedule:
    # 9:30 JST = 00:30 UTC
    - cron: "30 0 * * 1-5"
    # 12:30 JST = 03:30 UTC
    - cron: "30 3 * * 1-5"
    # 16:30 JST = 07:30 UTC
    - cron: "30 7 * * 1-5"
  workflow_dispatch:
    inputs:
      session:
        description: "セッション名"
        default: "手動実行"

jobs:
  report:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv pip install --system -r requirements.txt

      - name: Determine session name
        id: session
        run: |
          if [ -n "${{ github.event.inputs.session }}" ]; then
            echo "name=${{ github.event.inputs.session }}" >> "$GITHUB_OUTPUT"
          else
            HOUR=$(TZ=Asia/Tokyo date +%H)
            if [ "$HOUR" -lt 11 ]; then
              echo "name=寄り付き" >> "$GITHUB_OUTPUT"
            elif [ "$HOUR" -lt 15 ]; then
              echo "name=後場寄り" >> "$GITHUB_OUTPUT"
            else
              echo "name=終値" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Fetch portfolio
        id: portfolio
        run: |
          python portfolio.py "${{ steps.session.outputs.name }}"
          if [ -s portfolio.html ]; then
            echo "has_results=true" >> "$GITHUB_OUTPUT"
            echo "subject=$(cat portfolio_subject.txt)" >> "$GITHUB_OUTPUT"
          fi

      - name: Send email
        if: steps.portfolio.outputs.has_results == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.GMAIL_ADDRESS }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: ${{ steps.portfolio.outputs.subject }}
          to: ${{ secrets.GMAIL_ADDRESS }}
          from: ${{ secrets.GMAIL_ADDRESS }}
          html_body: file://portfolio.html
